<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamWeb - Edit√∂r Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #48bb78;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        /* --- ANƒ∞MASYONLU ARKA PLAN --- */
        body { 
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; /* Merkeze aldƒ±k */
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow-x: hidden;
            position: relative;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .bg-particle {
            position: fixed;
            bottom: -50px;
            color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
            z-index: 0;
            will-change: transform;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            20% { opacity: 0.6; }
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; }
        }

        /* --- DAHA K√ú√á√úK WRAPPER --- */
        .editor-wrapper { width: 100%; max-width: 650px; z-index: 10; position: relative; }

        /* --- KOMPAKT GLASS PANEL --- */
        .editor-container { 
            background: rgba(255, 255, 255, 0.92); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 22px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
            overflow: hidden; 
        }

        .stepper-header { display: flex; justify-content: space-between; margin-bottom: 20px; position: relative; padding: 0 40px; }
        .stepper-header::before { content: ""; position: absolute; top: 50%; left: 40px; right: 40px; height: 2px; background: rgba(0,0,0,0.05); z-index: 1; transform: translateY(-50%); }
        .step-circle { width: 32px; height: 32px; background: white; border: 2px solid #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; font-size: 13px; font-weight: 600; color: #999; }
        .step-circle.active { background: var(--primary); border-color: var(--primary); color: white; box-shadow: 0 0 10px rgba(102,126,234,0.4); }
        .step-circle.completed { background: var(--success); border-color: var(--success); color: white; }

        .step-content { padding: 30px; display: none; }
        .step-content.active { display: block; animation: slideIn 0.4s ease; }

        h3 { font-size: 18px; margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 10px; }

        /* --- KOMPAKT FORM ELEMANLARI --- */
        .form-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px; color: #555; }
        .input-style { width: 100%; padding: 11px 15px; background: #fdfdfd; border: 1px solid #e2e8f0; border-radius: 10px; outline: none; transition: 0.3s; font-size: 14px; }
        .input-style:focus { border-color: var(--primary); background: white; }

        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .theme-card { background: #f8fafc; border: 2px solid #f1f5f9; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; }
        .theme-card.selected { border-color: var(--primary); background: #f0f7ff; }
        .theme-card i { font-size: 24px; margin-bottom: 8px; display: block; }
        .theme-card strong { font-size: 13px; }

        .photo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .photo-slot { aspect-ratio: 1; background: #fff; border: 2px dashed #e2e8f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .photo-slot.has-img { border-style: solid; border-color: var(--success); }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        .delete-btn { position: absolute; top: 3px; right: 3px; background: #ff4d4d; color: white; border: none; width: 18px; height: 18px; border-radius: 50%; display: none; cursor: pointer; font-size: 10px; z-index: 5; }

        .footer-nav { padding: 15px 30px; background: #fbfcfe; display: flex; justify-content: space-between; border-top: 1px solid #f1f5f9; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; font-size: 14px; }
        .btn-next { background: var(--primary); color: white; }
        .btn-prev { background: #e2e8f0; color: #64748b; }
        .btn-submit { background: linear-gradient(to right, var(--primary), var(--secondary)); color: white; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 500px) { .photo-grid { grid-template-columns: repeat(2, 1fr); } .stepper-header { padding: 0 20px; } }
    </style>
</head>
<body>

<div class="editor-wrapper">
    <div class="stepper-header">
        <div class="step-circle active" id="dot1">1</div>
        <div class="step-circle" id="dot2">2</div>
        <div class="step-circle" id="dot3">3</div>
    </div>

    <div class="editor-container">
        <div class="step-content active" id="step1">
            <h3><i class="fas fa-magic" style="color:var(--primary)"></i> Tasarƒ±m Bilgileri</h3>
            <div class="form-group">
                <label>Konsept</label>
                <div class="theme-grid">
                    <div class="theme-card selected" onclick="selectTheme('love', this)">
                        <i class="fas fa-ring" style="color:#e74c3c"></i><strong>A≈ük Sayfasƒ±</strong>
                    </div>
                    <div class="theme-card" onclick="selectTheme('birthday', this)">
                        <i class="fas fa-birthday-cake" style="color:#f1c40f"></i><strong>Doƒüum G√ºn√º</strong>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Partner Adƒ±</label>
                <input type="text" id="partnerName" class="input-style" placeholder="√ñrn: Ruh ƒ∞kizim...">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Mesajƒ±n</label>
                <textarea id="proposalMessage" class="input-style" rows="2" placeholder="Ona ne demek istersin?"></textarea>
            </div>
        </div>

        <div class="step-content" id="step2">
            <h3><i class="fas fa-camera" style="color:var(--primary)"></i> Medya Y√ºkle</h3>
            <div class="form-group">
                <label>Arka Plan M√ºziƒüi</label>
                <input type="file" id="musicFile" accept="audio/*" class="input-style">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Fotoƒüraflar (8 Adet)</label>
                <input type="file" id="bulkInput" multiple accept="image/*" style="display:none;">
                <button class="btn" onclick="document.getElementById('bulkInput').click()" style="width:100%; margin-bottom:12px; border:1px solid #cbd5e0; color:#475569; background:#fff;">
                    <i class="fas fa-images"></i> Toplu Se√ß
                </button>
                <div class="photo-grid">
                    <script>
                        for(let i=1; i<=8; i++) {
                            document.write(`
                                <div class="photo-slot" id="slot${i}" onclick="triggerInput(${i})">
                                    <input type="file" class="photo-input" id="input${i}" accept="image/*" style="display:none;" onchange="handleSingleFile(this, ${i})">
                                    <i class="fas fa-plus" style="color:#cbd5e0; font-size:12px;"></i>
                                    <img src="" style="display:none;">
                                    <button class="delete-btn" onclick="removeImage(event, ${i})">√ó</button>
                                </div>
                            `);
                        }
                    </script>
                </div>
            </div>
        </div>

        <div class="step-content" id="step3">
            <div style="text-align:center; padding:10px;">
                <i class="fas fa-check-circle" style="font-size:45px; color:var(--success); margin-bottom:15px;"></i>
                <h2>Hazƒ±rsƒ±n!</h2>
                <p style="color:#64748b; font-size:14px; margin-top:5px;">Saniyeler i√ßinde a≈ük sayfan yayƒ±nda olacak.</p>
                <div id="statusMessage" style="margin-top:15px; font-size:14px;"></div>
            </div>
        </div>

        <div class="footer-nav">
            <button class="btn btn-prev" id="prevBtn" onclick="changeStep(-1)" style="visibility:hidden;">Geri</button>
            <button class="btn btn-next" id="nextBtn" onclick="changeStep(1)">Devam Et</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCuKzZVAA3K3dtlzxSmIc4h07CyqXMBk5Y", 
        authDomain: "lovespage61.firebaseapp.com", 
        projectId: "lovespage61", 
        storageBucket: "lovespage61.firebasestorage.app", 
        messagingSenderId: "954368938690", 
        appId: "1:954368938690:web:b6880d8524570e6e06a15b", 
        measurementId: "G-DR224E42S8" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);
    let currentUser = null;

    onAuthStateChanged(auth, u => { if(u) currentUser = u; else window.location.href="login.html"; });

    // --- KALƒ∞TELƒ∞ ANƒ∞MASYON MOTORU ---
    function startParticleFlow() {
        const symbols = ['‚ù§Ô∏è', 'üíç', 'üíñ', '‚ú®'];
        setInterval(() => {
            const p = document.createElement('div');
            p.className = 'bg-particle';
            p.innerHTML = symbols[Math.floor(Math.random() * symbols.length)];
            p.style.left = Math.random() * 100 + 'vw';
            p.style.fontSize = (Math.random() * 15 + 10) + 'px';
            const duration = Math.random() * 8 + 7;
            p.style.animation = `floatUp ${duration}s linear forwards`;
            document.body.appendChild(p);
            setTimeout(() => p.remove(), duration * 1000);
        }, 1200);
    }
    startParticleFlow();

    // --- STEP LOGIC ---
    let currentStep = 1;
    let selectedTheme = 'love';

    window.changeStep = (n) => {
        if (n === 1 && !validateStep()) return;
        currentStep += n;
        if (currentStep > 3) { startCreation(); return; }
        updateUI();
    };

    function validateStep() {
        if (currentStep === 1 && !document.getElementById('partnerName').value.trim()) { alert("ƒ∞sim yazmalƒ±sƒ±n!"); return false; }
        if (currentStep === 2 && document.querySelectorAll('.photo-slot.has-img').length === 0) { alert("En az 1 fotoƒüraf!"); return false; }
        return true;
    }

    function updateUI() {
        document.querySelectorAll('.step-content').forEach((s, i) => s.classList.toggle('active', i === currentStep - 1));
        document.querySelectorAll('.step-circle').forEach((d, i) => {
            d.classList.toggle('active', i === currentStep - 1);
            d.classList.toggle('completed', i < currentStep - 1);
        });
        document.getElementById('prevBtn').style.visibility = currentStep === 1 ? 'hidden' : 'visible';
        document.getElementById('nextBtn').innerText = currentStep === 3 ? "OLU≈ûTUR" : "Devam Et";
    }

    window.selectTheme = (t, el) => {
        selectedTheme = t;
        document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    };

    // --- PHOTO LOGIC ---
    window.triggerInput = (i) => document.getElementById(`input${i}`).click();
    window.handleSingleFile = (input, i) => { if(input.files[0]) showPreview(input.files[0], i); };
    
    document.getElementById('bulkInput').addEventListener('change', e => {
        const files = Array.from(e.target.files).slice(0, 8);
        files.forEach((file, i) => {
            const dt = new DataTransfer(); dt.items.add(file);
            const input = document.getElementById(`input${i+1}`);
            input.files = dt.files;
            showPreview(file, i+1);
        });
    });

    function showPreview(file, i) {
        const reader = new FileReader();
        reader.onload = e => {
            const slot = document.getElementById(`slot${i}`);
            const img = slot.querySelector('img');
            img.src = e.target.result; img.style.display = 'block';
            slot.querySelector('.fas').style.display = 'none';
            slot.querySelector('.delete-btn').style.display = 'block';
            slot.classList.add('has-img');
        };
        reader.readAsDataURL(file);
    }

    window.removeImage = (e, i) => {
        e.stopPropagation();
        const slot = document.getElementById(`slot${i}`);
        slot.querySelector('img').style.display = 'none';
        slot.querySelector('.fas').style.display = 'block';
        slot.querySelector('.delete-btn').style.display = 'none';
        slot.classList.remove('has-img');
        document.getElementById(`input${i}`).value = "";
    };

    // --- FIREBASE SAVE ---
    async function startCreation() {
        const status = document.getElementById('statusMessage');
        const nextBtn = document.getElementById('nextBtn');
        nextBtn.disabled = true;
        status.innerHTML = "‚è≥ Sihir yapƒ±lƒ±yor...";

        try {
            let musicUrl = selectedTheme === 'birthday' ? "https://cdn.pixabay.com/download/audio/2023/01/25/audio_245220757a.mp3" : "ses/sess.mp3";
            const musicFile = document.getElementById('musicFile').files[0];
            if(musicFile) {
                const mRef = ref(storage, `users/${currentUser.uid}/${Date.now()}`);
                await uploadBytes(mRef, musicFile);
                musicUrl = await getDownloadURL(mRef);
            }

            const imageUrls = [];
            const photoSlots = document.querySelectorAll('.photo-input');
            for(let i=0; i<photoSlots.length; i++) {
                const file = photoSlots[i].files[0];
                if(file) {
                    status.innerHTML = `üì∏ Resim ${imageUrls.length+1} y√ºkleniyor...`;
                    const iRef = ref(storage, `users/${currentUser.uid}/img_${Date.now()}_${i}`);
                    await uploadBytes(iRef, file);
                    imageUrls.push(await getDownloadURL(iRef));
                }
            }

            await addDoc(collection(db, "proposals"), {
                userId: currentUser.uid, theme: selectedTheme,
                partnerName: document.getElementById('partnerName').value,
                proposalMessage: document.getElementById('proposalMessage').value,
                musicUrl: musicUrl, images: imageUrls, createdAt: new Date()
            });

            status.innerHTML = "‚úÖ Harika! Y√∂nlendiriliyor...";
            setTimeout(() => window.location.href="dashboard.html", 1500);
        } catch(err) {
            alert(err.message);
            nextBtn.disabled = false;
        }
    }
</script>

</body>
</html>