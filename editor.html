<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamWeb Studio - EditÃ¶r</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6366f1; /* Modern Ä°ndigo */
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --surface: #ffffff;
            --background: #f8fafc;
            --text-main: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --radius: 16px;
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--background);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            /* Hafif mesh background */
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,0) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, transparent 50%);
            background-size: 100% 100%;
        }

        /* --- ANA KAPASÄ°TE --- */
        .studio-wrapper {
            width: 100%;
            max-width: 1000px;
            background: var(--surface);
            border-radius: 24px;
            box-shadow: var(--shadow);
            display: flex;
            overflow: hidden;
            min-height: 650px;
            position: relative;
        }

        /* --- SOL PANEL (SIDEBAR / STEPPER) --- */
        .studio-sidebar {
            width: 280px;
            background: #f1f5f9;
            padding: 40px 30px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }

        .brand {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 20px;
            color: var(--primary-dark);
            margin-bottom: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .steps-nav {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text-light);
            font-weight: 500;
            font-size: 14px;
            transition: 0.3s;
            position: relative;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
            transition: 0.3s;
            color: #94a3b8;
        }

        .step-item.active { color: var(--text-main); font-weight: 600; }
        .step-item.active .step-number { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .step-item.completed .step-number { background: var(--success); color: white; }
        
        /* BaÄŸlantÄ± Ã§izgisi */
        .step-item:not(:last-child)::after {
            content: ''; position: absolute; left: 16px; top: 32px;
            width: 2px; height: 18px; background: #e2e8f0;
        }

        /* --- SAÄž PANEL (Ä°Ã‡ERÄ°K) --- */
        .studio-content {
            flex: 1;
            padding: 40px 50px;
            position: relative;
            overflow-y: auto;
            max-height: 700px;
        }

        .close-btn {
            position: absolute; top: 25px; right: 25px;
            color: var(--text-light); font-size: 20px;
            cursor: pointer; transition: 0.2s;
            background: #f1f5f9; width: 36px; height: 36px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            text-decoration: none;
        }
        .close-btn:hover { background: #ffe4e6; color: #f43f5e; }

        h2 { font-family: 'Poppins', sans-serif; font-size: 24px; margin-bottom: 10px; color: var(--text-main); }
        p.subtitle { color: var(--text-light); font-size: 14px; margin-bottom: 30px; line-height: 1.5; }

        /* FORM ELEMANLARI */
        .form-group { margin-bottom: 24px; }
        label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        
        .input-style {
            width: 100%; padding: 14px 16px 14px 45px;
            background: #fff; border: 1px solid var(--border);
            border-radius: 12px; font-size: 15px; color: var(--text-main);
            transition: all 0.2s; font-family: 'Inter', sans-serif;
        }
        .input-style:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        textarea.input-style { resize: vertical; min-height: 100px; padding-left: 16px; }

        /* TEMA ROZETÄ° */
        .theme-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 16px; background: #eef2ff; color: var(--primary);
            border-radius: 50px; font-size: 13px; font-weight: 600;
            margin-bottom: 20px; border: 1px solid #c7d2fe;
        }

        /* TIMELINE STÄ°LÄ° */
        .timeline-box {
            background: #fff; border: 1px solid var(--border);
            border-radius: 16px; padding: 20px; margin-bottom: 15px;
            position: relative; transition: 0.2s;
        }
        .timeline-box:hover { border-color: var(--primary); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .timeline-box h4 { font-size: 12px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 700; }

        /* MEDYA GRID */
        .media-upload-area {
            border: 2px dashed var(--border); border-radius: 16px;
            padding: 20px; text-align: center; margin-bottom: 20px;
            cursor: pointer; transition: 0.2s; background: #f8fafc;
        }
        .media-upload-area:hover { border-color: var(--primary); background: #eef2ff; }
        
        .photo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px; }
        .photo-slot {
            aspect-ratio: 1; border-radius: 12px; overflow: hidden;
            background: #f1f5f9; position: relative; border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
        }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        .photo-slot i { color: #cbd5e0; font-size: 20px; }
        .photo-slot:hover { border-color: var(--primary); }
        .delete-btn {
            position: absolute; top: 5px; right: 5px;
            background: rgba(0,0,0,0.6); color: white; border: none;
            width: 22px; height: 22px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px;
        }

        /* BUTTONS */
        .footer-actions {
            margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn {
            padding: 12px 28px; border-radius: 10px; font-weight: 600;
            font-size: 14px; cursor: pointer; border: none; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-ghost { background: transparent; color: var(--text-light); }
        .btn-ghost:hover { color: var(--text-main); background: #f1f5f9; }

        /* STEP CONTENT VISIBILITY */
        .step-content { display: none; animation: fadeIn 0.4s ease; }
        .step-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* MOBÄ°L UYUM */
        @media (max-width: 800px) {
            .studio-wrapper { flex-direction: column; height: 100vh; max-height: none; border-radius: 0; }
            .studio-sidebar { width: 100%; padding: 20px; flex-direction: row; align-items: center; justify-content: space-between; height: 80px; border-bottom: 1px solid var(--border); border-right: none; }
            .brand { margin-bottom: 0; font-size: 18px; }
            .steps-nav { flex-direction: row; gap: 10px; }
            .step-text { display: none; } /* Mobilde sadece yuvarlak numaralar kalsÄ±n */
            .step-item:not(:last-child)::after { display: none; }
            .studio-content { padding: 20px; }
            .photo-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <div class="studio-wrapper">
        <aside class="studio-sidebar">
            <div class="brand">
                <i class="fas fa-layer-group" style="color:var(--primary)"></i> DreamWeb
            </div>
            
            <div class="steps-nav">
                <div class="step-item active" id="dot1">
                    <div class="step-number">1</div>
                    <span class="step-text">Temel Bilgiler</span>
                </div>
                <div class="step-item" id="dot2">
                    <div class="step-number">2</div>
                    <span class="step-text">Hikaye TÃ¼neli</span>
                </div>
                <div class="step-item" id="dot3">
                    <div class="step-number">3</div>
                    <span class="step-text">GÃ¶rsel & Medya</span>
                </div>
                <div class="step-item" id="dot4">
                    <div class="step-number"><i class="fas fa-check"></i></div>
                    <span class="step-text">YayÄ±nla</span>
                </div>
            </div>
        </aside>

        <main class="studio-content">
            <a href="dashboard.html" class="close-btn"><i class="fas fa-times"></i></a>

            <div class="step-content active" id="step1">
                <div class="theme-badge" id="themeInfoBadge">
                    <i class="fas fa-spinner fa-spin"></i> YÃ¼kleniyor...
                </div>
                <h2>Projeye BaÅŸlayalÄ±m</h2>
                <p class="subtitle">Ã–zel sayfanÄ±z iÃ§in gerekli olan temel bilgileri aÅŸaÄŸÄ±ya girin.</p>

                <div class="form-group">
                    <label id="lblPartner">Ä°sim</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" id="partnerName" class="input-style" placeholder="Ã–rn: AyÅŸe">
                    </div>
                </div>

                <div class="form-group">
                    <label id="lblDate">Tarih</label>
                    <div class="input-wrapper">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="datetime-local" id="relationshipDate" class="input-style">
                    </div>
                </div>

                <div class="form-group">
                    <label id="lblMsg">Ana Mesaj</label>
                    <textarea id="proposalMessage" class="input-style" placeholder="SayfanÄ±n en dikkat Ã§ekici mesajÄ±..."></textarea>
                </div>
            </div>

            <div class="step-content" id="step2">
                <h2>Hikayenizi AnlatÄ±n</h2>
                <p class="subtitle">ZiyaretÃ§iler aÅŸaÄŸÄ± kaydÄ±rdÄ±kÃ§a gÃ¶rÃ¼necek 3 Ã¶nemli anÄ± belirleyin.</p>

                <div class="timeline-box">
                    <h4><i class="fas fa-flag"></i> 1. BaÅŸlangÄ±Ã§</h4>
                    <input type="text" id="t1_title" class="input-style" style="margin-bottom:10px; font-weight:600;" placeholder="BaÅŸlÄ±k">
                    <textarea id="t1_desc" class="input-style" rows="2" placeholder="O anÄ± anlat..."></textarea>
                </div>

                <div class="timeline-box">
                    <h4><i class="fas fa-heart"></i> 2. GeliÅŸme</h4>
                    <input type="text" id="t2_title" class="input-style" style="margin-bottom:10px; font-weight:600;" placeholder="BaÅŸlÄ±k">
                    <textarea id="t2_desc" class="input-style" rows="2" placeholder="O anÄ± anlat..."></textarea>
                </div>

                <div class="timeline-box">
                    <h4><i class="fas fa-infinity"></i> 3. Final</h4>
                    <input type="text" id="t3_title" class="input-style" style="margin-bottom:10px; font-weight:600;" placeholder="BaÅŸlÄ±k">
                    <textarea id="t3_desc" class="input-style" rows="2" placeholder="O anÄ± anlat..."></textarea>
                </div>
            </div>

            <div class="step-content" id="step3">
                <h2>Medya Ekle</h2>
                <p class="subtitle">SayfanÄ±zÄ± canlandÄ±rmak iÃ§in mÃ¼zik ve fotoÄŸraflar ekleyin.</p>

                <div class="form-group">
                    <label>Arka Plan MÃ¼ziÄŸi</label>
                    <div class="input-wrapper">
                        <i class="fas fa-music"></i>
                        <input type="file" id="musicFile" accept="audio/*" class="input-style" style="padding-left: 45px;">
                    </div>
                </div>

                <div class="form-group">
                    <label>FotoÄŸraf Galerisi (4-8 Adet)</label>
                    <input type="file" id="bulkInput" multiple accept="image/*" style="display:none;">
                    
                    <div class="media-upload-area" onclick="document.getElementById('bulkInput').click()">
                        <i class="fas fa-cloud-upload-alt" style="font-size:30px; color:var(--primary); margin-bottom:10px;"></i>
                        <p style="font-weight:600; font-size:14px;">FotoÄŸraflarÄ± SeÃ§mek Ä°Ã§in TÄ±kla</p>
                        <p style="font-size:12px; color:var(--text-light);">veya buraya sÃ¼rÃ¼kle</p>
                    </div>

                    <div class="photo-grid">
                        <script>
                            // HTML iÃ§inde JS dÃ¶ngÃ¼sÃ¼ olmadÄ±ÄŸÄ± iÃ§in burayÄ± statik olarak, ama dinamik ID'lerle oluÅŸturuyoruz
                            for(let i=1; i<=8; i++) {
                                document.write(`
                                    <div class="photo-slot" id="slot${i}" onclick="triggerInput(${i})">
                                        <input type="file" class="photo-input" id="input${i}" accept="image/*" style="display:none;" onchange="handleSingleFile(this, ${i})">
                                        <i class="fas fa-plus"></i>
                                        <img src="" style="display:none;">
                                        <button class="delete-btn" onclick="removeImage(event, ${i})" style="display:none;"><i class="fas fa-times"></i></button>
                                    </div>
                                `);
                            }
                        </script>
                    </div>
                </div>
            </div>

            <div class="step-content" id="step4">
                <div style="text-align:center; padding-top:60px;">
                    <div style="width:100px; height:100px; background:#ecfdf5; color:#10b981; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 30px auto; font-size:40px;">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h2>Her Åžey HazÄ±r!</h2>
                    <p class="subtitle" style="max-width:400px; margin:0 auto 30px auto;">
                        TÃ¼m bilgileri girdiniz. Åžimdi sihirli butona basarak web sitenizi oluÅŸturun ve sevdiklerinizle paylaÅŸÄ±n.
                    </p>
                    <div id="statusMessage" style="font-weight:600; color:var(--primary); min-height:25px; margin-bottom:20px;"></div>
                </div>
            </div>

            <div class="footer-actions">
                <button class="btn btn-ghost" id="prevBtn" onclick="changeStep(-1)" style="visibility:hidden;">
                    <i class="fas fa-arrow-left"></i> Geri
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                    Devam Et <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // FIREBASE CONFIG (Senin projene ait ayarlar)
        const firebaseConfig = { 
            apiKey: "AIzaSyCuKzZVAA3K3dtlzxSmIc4h07CyqXMBk5Y", 
            authDomain: "lovespage61.firebaseapp.com", 
            projectId: "lovespage61", 
            storageBucket: "lovespage61.firebasestorage.app", 
            messagingSenderId: "954368938690", 
            appId: "1:954368938690:web:b6880d8524570e6e06a15b", 
            measurementId: "G-DR224E42S8" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        let currentUser = null;

        // KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸ mÄ± kontrolÃ¼
        onAuthStateChanged(auth, u => { 
            if(u) {
                currentUser = u; 
            } else {
                window.location.href = "login.html"; 
            }
        });

        // --- URL PARAMETRE KONTROLÃœ (OTOMATÄ°K TEMA SEÃ‡Ä°MÄ°) ---
        let selectedTheme = 'love'; 

        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const templateParam = urlParams.get('template'); 
            
            if(templateParam === 'birthday') {
                selectedTheme = 'birthday';
                setupTheme('birthday');
            } else {
                selectedTheme = 'love';
                setupTheme('love');
            }
        });

        function setupTheme(theme) {
            const badge = document.getElementById('themeInfoBadge');
            
            if(theme === 'birthday') {
                badge.innerHTML = `<i class="fas fa-birthday-cake"></i> DoÄŸum GÃ¼nÃ¼ Projesi`;
                badge.style.color = "#d97706"; badge.style.background = "#fffbeb"; badge.style.borderColor = "#fcd34d";
                
                document.getElementById('lblPartner').innerText = "DoÄŸum GÃ¼nÃ¼ Ã‡ocuÄŸu";
                document.getElementById('partnerName').placeholder = "Ã–rn: CanÄ±m ArkadaÅŸÄ±m, AyÅŸe...";
                document.getElementById('lblDate').innerText = "DoÄŸum Tarihi";
                document.getElementById('lblMsg').innerText = "Kutlama MesajÄ±";
                document.getElementById('proposalMessage').value = "Ä°yi ki doÄŸdun! Nice mutlu yaÅŸlara... ðŸŽ‚";
                
                document.getElementById('t1_title').value = "DÃ¼nyaya Merhaba";
                document.getElementById('t1_desc').value = "Senin doÄŸduÄŸun gÃ¼n, dÃ¼nya daha gÃ¼zel bir yer oldu.";
                document.getElementById('t2_title').value = "Birlikte GÃ¼zel AnÄ±lar";
                document.getElementById('t2_desc').value = "PaylaÅŸtÄ±ÄŸÄ±mÄ±z her an benim iÃ§in Ã§ok deÄŸerli.";
                document.getElementById('t3_title').value = "Yeni YaÅŸÄ±n";
                document.getElementById('t3_desc').value = "Yeni yaÅŸÄ±nda tÃ¼m hayallerin gerÃ§ek olsun.";
            
            } else {
                badge.innerHTML = `<i class="fas fa-heart"></i> AÅŸk / Teklif Projesi`;
                badge.style.color = "#db2777"; badge.style.background = "#fce7f3"; badge.style.borderColor = "#fbcfe8";

                document.getElementById('lblPartner').innerText = "Partnerinin AdÄ±";
                document.getElementById('partnerName').placeholder = "Ã–rn: Sevgilim...";
                document.getElementById('lblDate').innerText = "Ä°liÅŸki BaÅŸlangÄ±Ã§ Tarihi";
                document.getElementById('lblMsg').innerText = "Teklif / Ana Mesaj";
                document.getElementById('proposalMessage').value = "Benimle evlenir misin?";

                document.getElementById('t1_title').value = "Hikayemiz BaÅŸladÄ±";
                document.getElementById('t1_desc').value = "HayatÄ±mÄ±n en gÃ¼zel tesadÃ¼fÃ¼ seninle karÅŸÄ±laÅŸtÄ±ÄŸÄ±m o gÃ¼ndÃ¼...";
                document.getElementById('t2_title').value = "O BÃ¼yÃ¼lÃ¼ An";
                document.getElementById('t2_desc').value = "GÃ¶zlerine ilk baktÄ±ÄŸÄ±mda evimi bulduÄŸumu hissettim.";
                document.getElementById('t3_title').value = "SonsuzluÄŸa Ä°lk AdÄ±m";
                document.getElementById('t3_desc').value = "Ve bugÃ¼n, Ã¶mrÃ¼mÃ¼ seninle birleÅŸtirme sÃ¶zÃ¼ veriyorum.";
            }
        }

        // --- STEP LOGIC (ADIMLAR ARASI GEÃ‡Ä°Åž) ---
        let currentStep = 1;
        const totalSteps = 4;

        // window'a atÄ±yoruz ki HTML onclick ile Ã§alÄ±ÅŸabilsin
        window.changeStep = (n) => {
            if (n === 1 && !validateStep()) return;
            currentStep += n;
            if (currentStep > totalSteps) { startCreation(); return; }
            if (currentStep < 1) currentStep = 1;
            updateUI();
        };

        function validateStep() {
            if (currentStep === 1) {
                if (!document.getElementById('partnerName').value.trim()) { alert("Ä°sim alanÄ± boÅŸ bÄ±rakÄ±lamaz!"); return false; }
                if (!document.getElementById('relationshipDate').value) { alert("LÃ¼tfen bir tarih seÃ§in!"); return false; }
            }
            if (currentStep === 3) {
                // GÃ¶rÃ¼nÃ¼r olan (yÃ¼klenmiÅŸ) resim var mÄ±?
                const uploadedImages = document.querySelectorAll('.photo-slot img[style="display: block;"]');
                if (uploadedImages.length < 1) { alert("En az 1 fotoÄŸraf yÃ¼klemelisin!"); return false; }
            }
            return true;
        }

        function updateUI() {
            // Content Toggle
            document.querySelectorAll('.step-content').forEach((s, i) => {
                s.classList.remove('active');
                if(i === currentStep - 1) s.classList.add('active');
            });

            // Sidebar Stepper Update
            document.querySelectorAll('.step-item').forEach((d, i) => {
                d.classList.remove('active', 'completed');
                if (i < currentStep - 1) d.classList.add('completed');
                if (i === currentStep - 1) d.classList.add('active');
            });

            // Buttons
            document.getElementById('prevBtn').style.visibility = currentStep === 1 ? 'hidden' : 'visible';
            const nextBtn = document.getElementById('nextBtn');
            
            if(currentStep === totalSteps) {
                nextBtn.innerHTML = 'SÄ°TEYÄ° OLUÅžTUR <i class="fas fa-magic"></i>';
                nextBtn.style.background = "#10b981"; // Green for success
            } else {
                nextBtn.innerHTML = 'Devam Et <i class="fas fa-arrow-right"></i>';
                nextBtn.style.background = ""; // Default Primary
            }
        }

        // --- FOTOÄžRAF Ä°ÅžLEMLERÄ° ---
        
        // Slot'a tÄ±klayÄ±nca input'u aÃ§
        window.triggerInput = (i) => {
            document.getElementById(`input${i}`).click();
        };

        // Tekli dosya seÃ§imi
        window.handleSingleFile = (input, i) => { 
            if(input.files[0]) showPreview(input.files[0], i); 
        };
        
        // Toplu seÃ§im (Drag drop veya buton)
        document.getElementById('bulkInput').addEventListener('change', e => {
            const files = Array.from(e.target.files).slice(0, 8); // En fazla 8 dosya al
            files.forEach((file, i) => {
                const dt = new DataTransfer(); 
                dt.items.add(file);
                const input = document.getElementById(`input${i+1}`);
                if(input) { 
                    input.files = dt.files; 
                    showPreview(file, i+1); 
                }
            });
        });

        function showPreview(file, i) {
            const reader = new FileReader();
            reader.onload = e => {
                const slot = document.getElementById(`slot${i}`);
                const img = slot.querySelector('img');
                const plusIcon = slot.querySelector('.fa-plus');
                const delBtn = slot.querySelector('.delete-btn');

                img.src = e.target.result; 
                img.style.display = 'block';
                plusIcon.style.display = 'none';
                delBtn.style.display = 'flex';
                
                // Style update
                slot.style.borderStyle = 'solid';
                slot.style.borderColor = 'var(--success)';
            };
            reader.readAsDataURL(file);
        }

        window.removeImage = (e, i) => {
            e.stopPropagation(); // Slotun onclick olayÄ±nÄ± tetiklememesi iÃ§in
            const slot = document.getElementById(`slot${i}`);
            slot.querySelector('img').style.display = 'none';
            slot.querySelector('.fa-plus').style.display = 'block';
            slot.querySelector('.delete-btn').style.display = 'none';
            slot.style.borderStyle = '';
            slot.style.borderColor = '';
            // Input deÄŸerini temizle
            document.getElementById(`input${i}`).value = "";
        };

        // --- KAYIT Ä°ÅžLEMÄ° (FINAL) ---
        async function startCreation() {
            const status = document.getElementById('statusMessage');
            const nextBtn = document.getElementById('nextBtn');
            
            nextBtn.disabled = true;
            nextBtn.style.opacity = "0.7";
            status.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Dosyalar yÃ¼kleniyor...';

            try {
                // 1. MÃ¼zik YÃ¼kleme
                let musicUrl = "";
                const musicFile = document.getElementById('musicFile').files[0];
                if(musicFile) {
                    const mRef = ref(storage, `users/${currentUser.uid}/music_${Date.now()}`);
                    await uploadBytes(mRef, musicFile);
                    musicUrl = await getDownloadURL(mRef);
                }

                // 2. Resimler YÃ¼kleme
                const imageUrls = [];
                const photoSlots = document.querySelectorAll('.photo-input');
                
                // SlotlarÄ± gez
                for(let i=0; i<photoSlots.length; i++) {
                    const file = photoSlots[i].files[0];
                    if(file) {
                        status.innerText = `GÃ¶rsel ${imageUrls.length + 1} yÃ¼kleniyor...`;
                        const iRef = ref(storage, `users/${currentUser.uid}/img_${Date.now()}_${i}`);
                        await uploadBytes(iRef, file);
                        imageUrls.push(await getDownloadURL(iRef));
                    }
                }

                // 3. VeritabanÄ±na Yazma
                status.innerText = "Site oluÅŸturuluyor...";
                
                await addDoc(collection(db, "proposals"), {
                    userId: currentUser.uid,
                    templateId: selectedTheme, // birthday veya love
                    partnerName: document.getElementById('partnerName').value,
                    proposalMessage: document.getElementById('proposalMessage').value,
                    relationshipDate: document.getElementById('relationshipDate').value,
                    timeline: [
                        { title: document.getElementById('t1_title').value, desc: document.getElementById('t1_desc').value },
                        { title: document.getElementById('t2_title').value, desc: document.getElementById('t2_desc').value },
                        { title: document.getElementById('t3_title').value, desc: document.getElementById('t3_desc').value }
                    ],
                    musicUrl: musicUrl,
                    images: imageUrls, // Array olarak kaydet
                    status: 'active', 
                    createdAt: new Date()
                });

                status.innerHTML = `<span style="color:var(--success)">âœ… BaÅŸarÄ±lÄ±! Panelinize yÃ¶nlendiriliyorsunuz...</span>`;
                
                // 2 saniye sonra panele yÃ¶nlendir
                setTimeout(() => window.location.href = "dashboard.html", 2000);

            } catch(err) {
                console.error(err);
                status.innerHTML = `<span style="color:#ef4444">Hata: ${err.message}</span>`;
                nextBtn.disabled = false;
                nextBtn.style.opacity = "1";
            }
        }
    </script>
</body>
</html>