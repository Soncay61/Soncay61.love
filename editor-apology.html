<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Özür Editörü - DreamWeb</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #7c3aed; --bg: #f8fafc; --white: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        
        .editor-container { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        
        .panel { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        h2 { font-family: 'Poppins', sans-serif; margin-top: 0; color: #333; }
        label { display: block; margin-top: 15px; font-size: 13px; font-weight: 600; color: #64748b; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-family: inherit; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }

        /* KART EKLEME ALANI */
        .memory-builder { border: 2px dashed #e2e8f0; padding: 20px; border-radius: 15px; text-align: center; margin-top: 20px; transition: 0.3s; }
        .memory-builder:hover { border-color: var(--primary); background: #f5f3ff; }
        
        .card-preview-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; max-height: 500px; overflow-y: auto; }
        
        .mini-card { display: flex; gap: 15px; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; align-items: center; }
        .mini-card img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        .mini-info { flex: 1; }
        .mini-info h4 { margin: 0; font-size: 14px; }
        .mini-info p { margin: 5px 0 0 0; font-size: 12px; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .btn-del { background: #fee2e2; color: #ef4444; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }

        .btn-add { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; margin-top: 10px; width: 100%; }
        .btn-save { grid-column: 1 / -1; background: #10b981; color: white; padding: 15px; border-radius: 12px; border: none; cursor: pointer; font-size: 18px; font-weight: 700; margin-top: 20px; }
        .btn-save:disabled { opacity: 0.7; cursor: not-allowed; }

        @media (max-width: 768px) { .editor-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="editor-container">
        <div class="panel">
            <h2><i class="fas fa-heart-broken" style="color:var(--primary)"></i> Beni Affet</h2>
            <p style="font-size:13px; color:#666;">Onu ne kadar çok sevdiğini ve pişmanlığını anlat.</p>

            <label>Partnerinin Adı</label>
            <input type="text" id="partnerName" placeholder="Örn: Canım Sevgilim">

            <label>Giriş Başlığı (Büyük Yazı)</label>
            <input type="text" id="mainTitle" value="Lütfen Beni Affet..." placeholder="Örn: Seni Çok Üzdüm...">

            <label>Uzun Özür Mektubu</label>
            <textarea id="apologyLetter" rows="6" placeholder="Buraya içini dök. Neden üzgünsün, ne kadar pişmansın..."></textarea>

            <label>Müzik Seç</label>
            <input type="file" id="musicFile" accept="audio/*">
        </div>

        <div class="panel">
            <h2>Anı Kartları</h2>
            <p style="font-size:13px; color:#666;">Fotoğrafları yükle ve üzerine gelince çıkacak yazıyı yaz.</p>

            <div class="memory-builder">
                <input type="file" id="cardImageInput" accept="image/*" style="display:none;" onchange="previewCardImage(this)">
                <img id="tempImg" src="" style="width:100px; height:100px; object-fit:cover; display:none; margin:0 auto; border-radius:10px;">
                
                <button class="btn-add" onclick="document.getElementById('cardImageInput').click()" style="background:#e2e8f0; color:#333; margin-bottom:10px;">
                    <i class="fas fa-camera"></i> Fotoğraf Seç
                </button>
                
                <input type="text" id="cardTextInput" placeholder="Fotoğrafın Hikayesi (Örn: İlk buluşmamız...)">
                
                <button class="btn-add" onclick="addMemoryCard()">Listeye Ekle <i class="fas fa-plus"></i></button>
            </div>

            <div class="card-preview-list" id="cardList">
                </div>
        </div>

        <button class="btn-save" id="saveBtn" onclick="saveProject()">SİTEYİ OLUŞTUR <i class="fas fa-magic"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyCuKzZVAA3K3dtlzxSmIc4h07CyqXMBk5Y", authDomain: "lovespage61.firebaseapp.com", projectId: "lovespage61", storageBucket: "lovespage61.firebasestorage.app", messagingSenderId: "954368938690", appId: "1:954368938690:web:b6880d8524570e6e06a15b", measurementId: "G-DR224E42S8" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        let currentUser = null;

        onAuthStateChanged(auth, u => { if(u) currentUser = u; else window.location.href="login.html"; });

        // --- KART EKLEME MANTIĞI ---
        let memoryCards = []; // { file: File, text: String }

        window.previewCardImage = (input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.getElementById('tempImg');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.addMemoryCard = () => {
            const fileInput = document.getElementById('cardImageInput');
            const textInput = document.getElementById('cardTextInput');
            
            if(!fileInput.files[0]) return alert("Lütfen bir fotoğraf seçin!");
            if(!textInput.value.trim()) return alert("Lütfen bir yazı yazın!");

            // Listeye Ekle
            const file = fileInput.files[0];
            const text = textInput.value;
            
            memoryCards.push({ file: file, text: text });
            renderCardList();

            // Formu Temizle
            fileInput.value = "";
            textInput.value = "";
            document.getElementById('tempImg').style.display = 'none';
        }

        window.removeCard = (index) => {
            memoryCards.splice(index, 1);
            renderCardList();
        }

        function renderCardList() {
            const list = document.getElementById('cardList');
            list.innerHTML = "";
            memoryCards.forEach((card, index) => {
                const url = URL.createObjectURL(card.file);
                list.innerHTML += `
                    <div class="mini-card">
                        <img src="${url}">
                        <div class="mini-info">
                            <h4>Anı #${index+1}</h4>
                            <p>${card.text}</p>
                        </div>
                        <button class="btn-del" onclick="removeCard(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        }

        // --- KAYIT İŞLEMİ ---
        window.saveProject = async () => {
            const btn = document.getElementById('saveBtn');
            const partnerName = document.getElementById('partnerName').value;
            
            if(memoryCards.length < 1) return alert("En az 1 anı kartı eklemelisin!");
            if(!partnerName) return alert("İsim girmelisin!");

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yükleniyor...';

            try {
                // 1. Müzik Yükle
                let musicUrl = "";
                const musicFile = document.getElementById('musicFile').files[0];
                if(musicFile) {
                    const mRef = ref(storage, `users/${currentUser.uid}/music_apo_${Date.now()}`);
                    await uploadBytes(mRef, musicFile);
                    musicUrl = await getDownloadURL(mRef);
                }

                // 2. Kart Resimlerini Yükle ve Veriyi Hazırla
                let processedCards = [];
                for(let i=0; i<memoryCards.length; i++) {
                    const card = memoryCards[i];
                    const iRef = ref(storage, `users/${currentUser.uid}/card_${Date.now()}_${i}`);
                    await uploadBytes(iRef, card.file);
                    const url = await getDownloadURL(iRef);
                    
                    processedCards.push({
                        imageUrl: url,
                        text: card.text
                    });
                }

                // 3. Veritabanına Yaz
                await addDoc(collection(db, "proposals"), {
                    userId: currentUser.uid,
                    templateId: 'apology',
                    partnerName: partnerName,
                    proposalMessage: document.getElementById('apologyLetter').value, // Mektup
                    mainTitle: document.getElementById('mainTitle').value,
                    memories: processedCards, // YENİ YAPI: {img, text} dizisi
                    musicUrl: musicUrl,
                    createdAt: new Date(),
                    status: 'active'
                });

                alert("Siten hazır! Paneline dönüyorsun...");
                window.location.href = "dashboard.html";

            } catch (error) {
                console.error(error);
                alert("Hata: " + error.message);
                btn.disabled = false;
                btn.innerHTML = 'Tekrar Dene';
            }
        }
    </script>
</body>
</html>